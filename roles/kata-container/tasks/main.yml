---

- name: "install kata container repo key"
  apt_key:
    url: "http://download.opensuse.org/repositories/home:/katacontainers:/releases:/x86_64:/master/xUbuntu_18.04/Release.key"
    state: present

- name: "add kata container repo"
  apt_repository:
    repo: "deb http://download.opensuse.org/repositories/home:/katacontainers:/releases:/x86_64:/master/xUbuntu_18.04/ /"
    state: present
    filename: kata-containers.list

- name: "install kata container packages"
  apt:
    name: kata-runtime,kata-proxy,kata-shim
    state: present
    update_cache: yes

- name: "check if docker is installed"
  stat:
    path: "/usr/bin/docker"
  register: docker

- name: "create system.d dir for docker"
  file:
    path: "/etc/systemd/system/docker.service.d/"
    state: directory
    mode: 0755
    owner: root
    group: root
  when: docker.stat.exists

- name: "deploy systemd file"
  template:
    src: kata-containers.conf
    dest: /etc/systemd/system/docker.service.d/kata-containers.conf
    mode: 0644
    owner: root
    group: root

- name: "reload daemon"
  systemd:
    daemon_reload: yes
    name: docker.service

- name: "restart docker"
  systemd:
    name: docker.service
    enabled: yes
    state: restarted

  
